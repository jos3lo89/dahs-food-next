// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(ADMIN)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  ADMIN
}

model Category {
  id        String    @id @default(cuid())
  name      String    @unique
  slug      String    @unique
  order     Int       @default(0)
  active    Boolean   @default(true)
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([active])
}

model Product {
  id                String             @id @default(cuid())
  name              String
  slug              String             @unique
  description       String?
  price             Decimal            @db.Decimal(10, 2)
  image             String
  images            Json?              @default("[]") // ["url1", "url2", "url3"]
  categoryId        String
  category          Category           @relation(fields: [categoryId], references: [id])
  active            Boolean            @default(true)
  featured          Boolean            @default(false)
  stock             Int                @default(999)
  orderItems        OrderItem[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  promotionProducts PromotionProduct[] // Nuevo: relación con promociones

  @@index([categoryId])
  @@index([active])
  @@index([featured])
}

model Promotion {
  id          String             @id @default(cuid())
  name        String
  description String?
  discount    Decimal            @db.Decimal(5, 2)
  code        String?            @unique
  startDate   DateTime
  endDate     DateTime
  active      Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  type        PromotionType      @default(DISCOUNT)
  image       String?
  featured    Boolean            @default(false)
  products    PromotionProduct[]
  packs       PromotionPack[]

  @@index([active])
  @@index([featured])
  @@index([startDate, endDate])
}

enum PromotionType {
  DISCOUNT
  PACK
  DAY_SPECIAL
  WEEK_DEAL
}

model PromotionProduct {
  id            String    @id @default(cuid())
  promotionId   String
  promotion     Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  productId     String
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  discountPrice Decimal?  @db.Decimal(10, 2)
  createdAt     DateTime  @default(now())

  @@unique([promotionId, productId])
  @@index([promotionId])
  @@index([productId])
}

model PromotionPack {
  id            String    @id @default(cuid())
  promotionId   String
  promotion     Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  items         Json // Array de {productId, quantity}
  originalPrice Decimal   @db.Decimal(10, 2)
  packPrice     Decimal   @db.Decimal(10, 2)
  image         String?
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([promotionId])
  @@index([active])
}

model Order {
  id                    String         @id @default(cuid())
  orderNumber           String         @unique // ORD-20250101-001
  customerName          String
  customerPhone         String
  customerEmail         String?
  customerAddress       String
  addressDetails        Json?
  items                 OrderItem[]
  subtotal              Decimal        @db.Decimal(10, 2)
  discount              Decimal        @default(0) @db.Decimal(10, 2)
  deliveryFee           Decimal        @default(0) @db.Decimal(10, 2)
  total                 Decimal        @db.Decimal(10, 2)
  status                OrderStatus    @default(PENDING)
  receiptImage          String?
  paymentMethod         PaymentMethod? // "culqi", "yape", "plin", "efectivo"
  paymentId             String? // ID de transacción
  notes                 String?        @db.Text
  estimatedDeliveryTime DateTime? // ✅ NUEVO - Hora estimada de entrega
  confirmedAt           DateTime? // ✅ NUEVO - Cuándo se confirmó
  preparingAt           DateTime? // ✅ NUEVO - Cuándo empezó preparación
  deliveredAt           DateTime? // ✅ NUEVO - Cuándo se entregó
  cancelledAt           DateTime? // ✅ NUEVO - Cuándo se canceló
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  promotionCode         String? // Nuevo: código de promoción usado

  @@index([orderNumber])
  @@index([status])
  @@index([customerEmail]) // ✅ NUEVO - Índice para buscar por email
  @@index([customerPhone]) // ✅ NUEVO - Índice para buscar por teléfono
  @@index([createdAt])
}

enum PaymentMethod {
  culqi
  yape
  plin
  efectivo
}

enum OrderStatus {
  PENDING // Pendiente
  CONFIRMED // Confirmado
  PREPARING // En preparación
  OUT_FOR_DELIVERY
  DELIVERED // Entregado
  CANCELLED // Cancelado
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  subtotal  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  @@index([orderId])
}
